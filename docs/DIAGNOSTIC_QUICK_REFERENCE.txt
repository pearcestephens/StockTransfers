╔══════════════════════════════════════════════════════════════════════╗
║           LOCK SYSTEM DIAGNOSTIC COG — QUICK REFERENCE               ║
╚══════════════════════════════════════════════════════════════════════╝

📍 LOCATION: Top-right corner of transfer pack page header (purple gradient)
🎯 ICON: ⚙️ Gear/Cog icon
🖱️ ACTION: Click to open comprehensive diagnostic modal

┌──────────────────────────────────────────────────────────────────────┐
│ WHAT YOU'LL SEE                                                      │
└──────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 1️⃣ CLIENT STATE                                                     │
│    • Transfer ID          → Current transfer number                │
│    • User ID              → Your user ID                            │
│    • Tab ID               → Unique identifier for this browser tab  │
│    • Mode                 → owning/spectator/requesting/acquiring   │
│    • Same Owner           → YES (RED BAR) / NO (PURPLE BAR)         │
│    • Lock Token           → 32-char hex or 'none'                   │
│    • Lock Alive           → YES (green) / NO (red)                  │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 2️⃣ SSE CONNECTION (Real-Time Updates)                              │
│    • Ready State          → 0=CONNECTING / 1=OPEN / 2=CLOSED        │
│    • URL                  → Full SSE endpoint with parameters       │
│    • Connected At         → ISO timestamp of connection start       │
│    • Duration             → How long connection has been open       │
│    • Reconnect Attempts   → 0-5 (warns if >3)                       │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 3️⃣ SERVER LOCK STATUS (Live from Database)                         │
│    • Locked               → YES (orange) / NO (green)               │
│    • Owner ID             → Who currently holds the lock            │
│    • Tab ID               → Which tab holds the lock                │
│    • Expires In           → Seconds remaining before auto-release   │
│    • Is My Lock?          → YES (green) / NO (orange)               │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 4️⃣ LAST BLOCKED INFO (When You See Purple/Red Bar)                 │
│    • Same Owner           → YES / NO                                │
│    • Same Tab             → YES / NO                                │
│    • Locked By            → User ID of lock holder                  │
│    • Locked Tab           → Tab ID of lock holder                   │
│    • Expires In           → When their lock expires                 │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 5️⃣ RECENT EVENTS (Last 20 Lock Operations)                         │
│    Scrollable log showing:                                          │
│    • Timestamp            → Local time of event                     │
│    • Event Type           → lock_event / sse_event / user_action    │
│    • Detail               → JSON preview (truncated to 100 chars)   │
│                                                                      │
│    Example Events:                                                  │
│    21:45:30  lock_event: {"state":"acquired","info":{...}}          │
│    21:45:35  lock_event: {"state":"blocked","info":{"same_own...}}  │
│    21:45:42  lock_event: {"state":"lost","info":{}}                 │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 6️⃣ SYSTEM HEALTH (Overall Status)                                  │
│    • SSE Connection       → ✓ HEALTHY / ✗ UNHEALTHY                │
│    • Lock State           → ✓ ACTIVE / ○ INACTIVE                  │
│    • Page State           → ✓ NORMAL / ⚠ ABNORMAL                  │
│    • Timestamp            → ISO 8601 format                         │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│ 🔘 ACTION BUTTONS (Bottom of Modal)                                 │
└──────────────────────────────────────────────────────────────────────┘

  [📋 Copy All]     → Copies full diagnostic JSON to clipboard
  [🔄 Refresh]      → Re-fetches all data (including server status)
  [✖️ Close]        → Dismisses modal

┌──────────────────────────────────────────────────────────────────────┐
│ 🎨 COLOR CODING                                                      │
└──────────────────────────────────────────────────────────────────────┘

  🟢 GREEN    → Healthy / Good / Active / Yes (my lock)
  🟠 ORANGE   → Warning / Attention needed / Other's lock
  🔴 RED      → Error / Unhealthy / Failed / Critical

┌──────────────────────────────────────────────────────────────────────┐
│ 🔍 COMMON DIAGNOSTIC SCENARIOS                                       │
└──────────────────────────────────────────────────────────────────────┘

❓ "Page is slow to load"
   → Check SSE Connection: Should be OPEN (1)
   → Check Reconnect Attempts: Should be 0
   → Look for repeated connection errors in event log

❓ "Another tab has control" but I only have one tab open
   → Check Server Lock Status: See who actually holds it
   → Check Tab ID: Compare server tab_id with yours
   → Check Expires In: Wait for lock to expire or force release

❓ "Red bar appeared but I didn't open another tab"
   → Check Last Blocked Info: Same Owner = YES
   → Check event log for recent 'acquired' events
   → May be zombie lock from crashed tab - wait 90s

❓ "Lock stolen instantly without request"
   → Check Same Owner flag: Should be YES
   → This is intentional for RED BAR (same browser/user)
   → Different devices trigger PURPLE BAR (60s request)

❓ "SSE keeps disconnecting"
   → Check Reconnect Attempts: If >3, investigate
   → Check Apache logs for lock_events.php errors
   → Run: tail -f apache_error.log | grep lock_events

┌──────────────────────────────────────────────────────────────────────┐
│ 📊 INTERPRETING THE DATA                                             │
└──────────────────────────────────────────────────────────────────────┘

HEALTHY STATE:
  ✓ Mode: owning
  ✓ SSE Ready State: 1 (OPEN)
  ✓ Lock Alive: YES
  ✓ Server Locked: YES
  ✓ Is My Lock?: YES
  ✓ Reconnect Attempts: 0
  ✓ System Health: All green checks

BLOCKED STATE (Normal):
  ○ Mode: spectator
  ○ SSE Ready State: Not connected OR connected but monitoring
  ○ Lock Alive: NO
  ○ Server Locked: YES
  ○ Is My Lock?: NO
  ○ Same Owner: YES (red bar) or NO (purple bar)

PROBLEM STATE:
  ✗ Mode: owning BUT Server "Is My Lock?" = NO
  ✗ SSE Ready State: 2 (CLOSED) but Lock Alive: YES
  ✗ Reconnect Attempts: 5 (maxed out)
  ✗ System Health: Any red ✗ marks

┌──────────────────────────────────────────────────────────────────────┐
│ 💾 EXPORT FORMAT (Copy All)                                          │
└──────────────────────────────────────────────────────────────────────┘

{
  "client": {
    "timestamp": "2025-10-02T21:45:30.123Z",
    "page": {
      "transferId": "13217",
      "userId": "1",
      "mode": "owning",
      "sameOwner": false
    },
    "lock": {
      "resourceKey": "transfer:13217",
      "ownerId": "1",
      "tabId": "abc-123-def-456",
      "token": "0123456789abcdef...",
      "alive": true,
      "endpoint": "/modules/transfers/stock/api/simple_lock.php"
    },
    "sse": {
      "readyState": 1,
      "readyStateText": "OPEN",
      "url": "http://...lock_events.php?resource=transfer:13217&...",
      "reconnectAttempts": 0,
      "connectedAt": "2025-10-02T21:45:25.000Z",
      "duration": "5s"
    },
    "eventLog": [
      {"time": "2025-10-02T21:45:30.000Z", "type": "lock_event", "detail": {...}}
    ]
  },
  "server": {
    "ok": true,
    "locked": true,
    "owner_id": "1",
    "tab_id": "abc-123-def-456",
    "expires_in": 75
  }
}

┌──────────────────────────────────────────────────────────────────────┐
│ ⚡ KEYBOARD SHORTCUTS                                                │
└──────────────────────────────────────────────────────────────────────┘

  (none currently - future enhancement: ESC to close)

┌──────────────────────────────────────────────────────────────────────┐
│ 📞 ESCALATION PATH                                                   │
└──────────────────────────────────────────────────────────────────────┘

1. Open diagnostic modal
2. Click "Copy All"
3. Paste into support ticket / GitHub issue
4. Include:
   - What you were doing when issue occurred
   - Expected behavior vs actual behavior
   - Screenshot of diagnostic modal (if helpful)

┌──────────────────────────────────────────────────────────────────────┐
│ 🔗 RELATED DOCUMENTATION                                             │
└──────────────────────────────────────────────────────────────────────┘

  • LOCK_SYSTEM_ARCHITECTURE.md   → Full technical architecture
  • LOCK_SYSTEM_DIAGNOSIS.md       → Root cause analysis & recovery
  • DIAGNOSTIC_COG_FEATURE.md      → This feature's full documentation
  • transfers_stock_memory_notes.md → Historical context

══════════════════════════════════════════════════════════════════════
 Last Updated: October 2, 2025 | Status: ✅ COMPLETE
══════════════════════════════════════════════════════════════════════
